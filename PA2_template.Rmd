---
title: "Effects of severe weather events in US on health and economy"
output: html_document
---

<!---
    Language: Your document should be written in English.
    Title: Your document should have a title that briefly summarizes your data analysis
    Synopsis: Immediately after the title, there should be a synopsis which describes and summarizes your analysis in at most 10 complete sentences.
    There should be a section titled Data Processing which describes (in words and code) how the data were loaded into R and processed for analysis. In particular, your analysis must start from the raw CSV file containing the data. You cannot do any preprocessing outside the document. If preprocessing is time-consuming you may consider using the cache = TRUE option for certain code chunks.
    There should be a section titled Results in which your results are presented.
    You may have other sections in your analysis, but Data Processing and Results are required.
    The analysis document must have at least one figure containing a plot.
    Your analyis must have no more than three figures. Figures may have multiple plots in them (i.e. panel plots), but there cannot be more than three figures total.
    You must show all your code for the work in your analysis document. This may make the document a bit verbose, but that is okay. In general, you should ensure that echo = TRUE for every code chunk (this is the default setting in knitr).
 accepted
-->

##Synopsis
In this analysis I explore the effects of severe weather events in the US on health and economy.

##Data Processing

First I load the [StormData](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2).
```{r cache = TRUE}
#Download and unzip the data file
#https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2
address <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
address <- sub("^https", "http", address) #https does not work
zipname <- "StormData.csv.bz2"
download.file(address,zipname)

#No need to unzip, R can is smart enough to read a zipped csv
stormdata <- read.csv(zipname)

#housekeeping - remove the zip as it is no longer needed
file.remove(zipname)
#housekeeping
rm(address, zipname)
```

Some more data preparation. I add a column called HEALTH that contains the number of people affected. I include both the fatalities and the injuries, i.e. the fataly and non-fataly injured. Secondly I add a column for the damages in dollars. For this I need to combine the columns with numbers and columns with alphabetical indictation, for the severity, "K" for thousands of dollars, "M" for millions, "B" for billions. Thirdly, I add a column for year. The first years a scarcely filled with data and inculde only data for a small number of event types. From the nineties onwards, there is a more complete set.
```{r}
#Add a health column
#This includes all those that are affected, i.e. killed or injured
stormdata$HEALTH <- stormdata$FATALITIES + stormdata$INJURIES

#Add a column that adds up the prop and crop damage
#Start with all zeros and then add propdmg and cropdmg multiplied by
#the correct number depending on "K", "M" or "B"
K <- 1000
M <- 1000000
B <- 1000000000

#Set damage to all zeros
stormdata$DAMAGE <- 0

#Add PROPDMG thousands, millions and billions
stormdata$DAMAGE[toupper(stormdata$PROPDMGEXP)=="K"] <-
  stormdata$DAMAGE[toupper(stormdata$PROPDMGEXP)=="K"] +
  stormdata$PROPDMG[toupper(stormdata$PROPDMGEXP)=="K"] * K
stormdata$DAMAGE[toupper(stormdata$PROPDMGEXP)=="M"] <-
  stormdata$DAMAGE[toupper(stormdata$PROPDMGEXP)=="M"] +
  stormdata$PROPDMG[toupper(stormdata$PROPDMGEXP)=="M"] * M
stormdata$DAMAGE[toupper(stormdata$PROPDMGEXP)=="B"] <-
  stormdata$DAMAGE[toupper(stormdata$PROPDMGEXP)=="B"] +
  stormdata$PROPDMG[toupper(stormdata$PROPDMGEXP)=="B"] * B

#Add CROPDMG thousands, millions and billions
stormdata$DAMAGE[toupper(stormdata$CROPDMGEXP)=="K"] <-
  stormdata$DAMAGE[toupper(stormdata$CROPDMGEXP)=="K"] +
  stormdata$CROPDMG[toupper(stormdata$CROPDMGEXP)=="K"] * K
stormdata$DAMAGE[toupper(stormdata$CROPDMGEXP)=="M"] <-
  stormdata$DAMAGE[toupper(stormdata$CROPDMGEXP)=="M"] +
  stormdata$CROPDMG[toupper(stormdata$CROPDMGEXP)=="M"] * M
stormdata$DAMAGE[toupper(stormdata$CROPDMGEXP)=="B"] <-
  stormdata$DAMAGE[toupper(stormdata$CROPDMGEXP)=="B"] +
  stormdata$CROPDMG[toupper(stormdata$CROPDMGEXP)=="B"] * B

#house keeping
rm(K, M , B)

#Use library lubridate
#Only the data for more recent years is relevant
library(lubridate)

#Add a YEAR colum to the data
stormdata$YEAR <- year(mdy_hms(stormdata$BGN_DATE))

#Take into account only the years for which we have more complete data
#I set the year to be larger or equal to 1995
complete_year <- 1995
stormdata <- stormdata[which(stormdata$YEAR >= complete_year),]

#I only need to keep the rows where the health impact > 0
#or the damage > 0
stormdata <- stormdata[which(stormdata$HEALTH > 0 |
                             stormdata$DAMAGE > 0),]


#unique(stormdata$EVTYPE)
#house keeping
rm(complete_year)

```


##Explore the health data

```{r}

#aggregate health effects over EVTYPE
#use !is.na or na.rm to exclude NA's
health <- aggregate(HEALTH ~ EVTYPE, data=stormdata, function(x) sum(x, na.rm = TRUE))

names(health)[2] <- "number_affected"

#calculate top10:
#order by number affected in decreasing order and take the first 10
health_top10 <- health[order(health$number_affected, 
                             decreasing = TRUE),][1:10,]

health_top10
```

##Explore the economic damage data

```{r}
#aggregate over economic damage
#fatalities do no have an effect on population health
#use !is.na or na.rm to exclude NA's
damage <- aggregate(DAMAGE ~ EVTYPE, data=stormdata, function(x) sum(x, na.rm = TRUE))

names(damage)[2] <- "damage"

#calculate top10:
#order by damage in decreasing order and take the first 10
damage_top10 <- damage[order(damage$damage, decreasing = TRUE),][1:10,]

damage_top10

```

##Results
<!---
    Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?
    Across the United States, which types of events have the greatest economic consequences?
-->
